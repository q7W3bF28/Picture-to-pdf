<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片转PDF在线工具 - 专业、免费、无限制</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #6366f1;
            --light: #f8fafc;
            --dark: #1e293b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6e6ff 100%);
            min-height: 100vh;
        }
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .main-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }
        .main-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.2), 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        .main-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .upload-zone {
            border: 2px dashed #c7d2fe;
            transition: all 0.3s ease;
            background: rgba(248, 250, 255, 0.5);
        }
        .upload-zone.dragover {
            border-color: var(--primary);
            background-color: #eef2ff;
            transform: scale(1.02);
        }
        .image-preview-item {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .image-preview-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
        }
        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.3));
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .image-preview-item:hover .image-overlay {
            opacity: 1;
        }
        .sortable-ghost {
            opacity: 0.6;
            border: 2px dashed var(--primary);
            background: #eef2ff;
            transform: scale(1.05);
        }
        .card {
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
            background: rgba(255, 255, 255, 0.7);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .card-header {
            cursor: pointer;
            padding: 1rem;
            background: rgba(248, 250, 255, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }
        .card-header:hover {
            background: rgba(238, 242, 255, 0.9);
        }
        .card-body {
            max-height: 1000px;
            transition: max-height 0.5s ease, opacity 0.4s ease, padding 0.4s ease;
            overflow: hidden;
            opacity: 1;
            padding: 0 1rem 1rem;
        }
        .card-body.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 1rem;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .step-progress {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            position: relative;
        }
        .step-progress::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #e2e8f0;
            transform: translateY(-50%);
            z-index: 1;
        }
        .step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #64748b;
            position: relative;
            z-index: 2;
        }
        .step.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .step.completed {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        .feature-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(99, 102, 241, 0.1);
            color: var(--secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .feature-badge i {
            margin-right: 0.25rem;
        }
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .tooltip {
            position: relative;
        }
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem;
            background: var(--dark);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
        }
        .sequence-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }
        .sequence-warning {
            background: rgba(245, 158, 11, 0.9);
        }
        .sequence-error {
            background: rgba(239, 68, 68, 0.9);
        }
    </style>
</head>

<body class="text-slate-800 min-h-screen flex flex-col">
    <div id="notification-container" class="fixed top-5 right-5 z-50 w-full max-w-sm space-y-2"></div>

    <div class="app-container flex-grow px-4 py-8">
        <header class="glass-card p-6 mb-8 flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">图片转PDF工具</h1>
                <p class="text-slate-600 mt-1">专业 • 简洁 • 高效 • 完全免费</p>
            </div>
            <div class="flex flex-wrap mt-4 md:mt-0">
                <span class="feature-badge"><i data-lucide="infinity" class="w-4 h-4"></i> 无数量限制</span>
                <span class="feature-badge"><i data-lucide="shield" class="w-4 h-4"></i> 隐私保护</span>
                <span class="feature-badge"><i data-lucide="zap" class="w-4 h-4"></i> 快速转换</span>
            </div>
        </header>

        <div class="step-progress mb-8">
            <div class="step completed" id="step-1">
                <i data-lucide="check" class="w-4 h-4"></i>
            </div>
            <div class="step active" id="step-2">2</div>
            <div class="step" id="step-3">3</div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div id="image-upload-section" class="lg:col-span-3 glass-card p-6">
                <div id="upload-zone" class="upload-zone rounded-xl p-8 text-center flex flex-col items-center justify-center min-h-[300px] text-slate-500 cursor-pointer transition-all duration-300">
                    <div class="p-4 bg-blue-50 rounded-full mb-4">
                        <i data-lucide="upload-cloud" class="w-10 h-10 text-blue-500"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-slate-700 mb-2">拖拽图片到此处</h2>
                    <p class="mb-4 text-slate-500">或点击选择文件</p>
                    <p class="text-sm text-slate-400">支持 JPG, PNG, BMP, WEBP 等格式, 不限数量和大小</p>
                    <input type="file" id="file-input" multiple accept="image/*" class="hidden">
                </div>

                <div id="image-preview-container" class="mt-6 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-medium text-slate-700">已上传图片 (<span id="image-count">0</span>)</h3>
                        <div class="flex gap-2">
                            <button id="sort-sequence-btn" class="text-sm text-blue-600 hover:text-blue-700 flex items-center hidden">
                                <i data-lucide="arrow-up-down" class="w-4 h-4 mr-1"></i> 按文件名排序
                            </button>
                            <button id="clear-all-btn" class="text-sm text-rose-600 hover:text-rose-700 flex items-center hidden">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> 清空所有
                            </button>
                        </div>
                    </div>
                    <div id="sortable-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="sticky top-6">
                    <div class="glass-card p-6 space-y-6">
                        <h2 class="text-xl font-bold text-slate-900 border-b pb-3">PDF 输出设置</h2>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold text-slate-800 flex items-center">
                                    <i data-lucide="settings-2" class="w-5 h-5 mr-2 text-blue-500"></i>
                                    页面设置
                                </h3>
                                <i data-lucide="chevron-down" class="w-5 h-5 transition-transform"></i>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <label for="page-size" class="block text-sm font-medium text-slate-600 mb-2">页面尺寸</label>
                                    <select id="page-size" class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="A4" selected>A4 (210 x 297 mm)</option>
                                        <option value="A3">A3 (297 x 420 mm)</option>
                                        <option value="A5">A5 (148 x 210 mm)</option>
                                        <option value="Letter">Letter (8.5 x 11 in)</option>
                                        <option value="Legal">Legal (8.5 x 14 in)</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-slate-600 mb-2">页面方向</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="orientation" value="portrait" checked class="mr-2 text-blue-600 focus:ring-blue-500">
                                            <span>纵向</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="orientation" value="landscape" class="mr-2 text-blue-600 focus:ring-blue-500">
                                            <span>横向</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-2">页边距 (mm)</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-xs text-slate-500 mb-1 block">上边距</label>
                                            <input type="number" id="margin-top" value="10" min="0" max="50" class="w-full p-2 border rounded-md text-center">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-500 mb-1 block">下边距</label>
                                            <input type="number" id="margin-bottom" value="10" min="0" max="50" class="w-full p-2 border rounded-md text-center">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-500 mb-1 block">左边距</label>
                                            <input type="number" id="margin-left" value="10" min="0" max="50" class="w-full p-2 border rounded-md text-center">
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-500 mb-1 block">右边距</label>
                                            <input type="number" id="margin-right" value="10" min="0" max="50" class="w-full p-2 border rounded-md text-center">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold text-slate-800 flex items-center">
                                    <i data-lucide="lock" class="w-5 h-5 mr-2 text-blue-500"></i>
                                    质量与安全
                                </h3>
                                <i data-lucide="chevron-down" class="w-5 h-5 transition-transform rotate-180"></i>
                            </div>
                            <div class="card-body collapsed">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-slate-600 mb-2">图像质量</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="quality" value="1.0" class="mr-3 text-blue-600 focus:ring-blue-500">
                                            <span>原始质量 (文件较大)</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="quality" value="0.92" class="mr-3 text-blue-600 focus:ring-blue-500">
                                            <span>高</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="quality" value="0.75" checked class="mr-3 text-blue-600 focus:ring-blue-500">
                                            <span>中 (推荐)</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="quality" value="0.5" class="mr-3 text-blue-600 focus:ring-blue-500">
                                            <span>低 (文件较小)</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="flex items-center cursor-pointer mb-2">
                                        <input type="checkbox" id="enable-password" class="mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="text-sm font-medium text-slate-600">密码保护</span>
                                    </label>
                                    <div id="password-container" class="hidden mt-3 pl-7">
                                        <input type="password" id="pdf-password" placeholder="输入PDF密码" class="w-full p-2 border rounded-md mb-2">
                                        <p class="text-xs text-slate-500">设置密码后，打开PDF时需要输入此密码</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold text-slate-800 flex items-center">
                                    <i data-lucide="sparkles" class="w-5 h-5 mr-2 text-blue-500"></i>
                                    高级功能
                                </h3>
                                <i data-lucide="chevron-down" class="w-5 h-5 transition-transform rotate-180"></i>
                            </div>
                            <div class="card-body collapsed">
                                <label class="flex items-center cursor-pointer mb-2">
                                    <input type="checkbox" id="enable-ocr" class="mr-3 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm font-medium text-slate-600">启用OCR (使PDF文本可搜索)</span>
                                </label>
                                <p id="ocr-warning" class="text-xs text-amber-600 mt-2 pl-7 hidden">
                                    <i data-lucide="alert-circle" class="w-4 h-4 inline mr-1"></i>
                                    注意: OCR为实验性功能, 会显著增加处理时间, 并可能导致浏览器无响应。
                                </p>
                            </div>
                        </div>
                        
                        <div class="pt-2">
                            <button id="generate-pdf-btn" class="main-button w-full text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center disabled:opacity-70" disabled>
                                <span id="btn-text">生成PDF文件</span>
                                <div id="btn-loader" class="loader hidden ml-2"></div>
                            </button>
                            <p id="progress-text" class="text-center text-sm text-slate-500 mt-3 h-5"></p>
                        </div>
                    </div>

                    <div class="glass-card p-4 mt-4 text-center text-sm text-slate-500">
                        <p>所有处理均在浏览器内完成，您的文件不会上传到任何服务器</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center py-6 px-8 text-slate-500 text-sm mt-8">
        <p>青圣出品，必属精品</p>
    </footer>

    <!-- Sequence Error Modal -->
    <div id="sequence-error-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full text-center fade-in">
            <div class="flex justify-center items-center mx-auto bg-amber-100 rounded-full w-16 h-16">
                <i data-lucide="alert-circle" class="w-10 h-10 text-amber-600"></i>
            </div>
            <h3 class="text-xl font-bold mt-4 text-slate-800">未能检测到文件名中的序列顺序</h3>
            <p class="text-slate-600 mt-3">为了保证PDF的正确页序，请确保文件名包含连续的数字编号（例如：<code>image-01.jpg</code>, <code>image-02.jpg</code>）。</p>
            <div class="bg-slate-50 p-3 rounded-lg mt-4 text-left">
                <p class="text-sm font-medium text-slate-700 mb-1">建议的文件命名方式：</p>
                <ul class="text-sm text-slate-600 list-disc pl-5">
                    <li>第1页.jpg, 第2页.jpg, 第3页.jpg</li>
                    <li>document-001.png, document-002.png</li>
                    <li>img_01.jpg, img_02.jpg, img_03.jpg</li>
                </ul>
            </div>
            <div class="mt-5 flex flex-col gap-3">
                <button id="ignore-sequence-btn" class="py-2 px-4 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors">
                    忽略警告继续
                </button>
                <button id="manual-sort-btn" class="py-2 px-4 bg-blue-600 text-white font-medium rounded-lg main-button">
                    手动调整顺序
                </button>
                <button id="close-modal-btn" class="py-2 px-4 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors">
                    重新选择文件
                </button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();

        const { PDFDocument, rgb, StandardFonts, PageSizes, degrees } = PDFLib;

        // DOM elements
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const sortableList = document.getElementById('sortable-list');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        const progressText = document.getElementById('progress-text');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const notificationContainer = document.getElementById('notification-container');
        const imageCount = document.getElementById('image-count');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const sortSequenceBtn = document.getElementById('sort-sequence-btn');
        
        const sequenceErrorModal = document.getElementById('sequence-error-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const ignoreSequenceBtn = document.getElementById('ignore-sequence-btn');
        const manualSortBtn = document.getElementById('manual-sort-btn');
        
        const enablePassword = document.getElementById('enable-password');
        const passwordContainer = document.getElementById('password-container');
        const pdfPassword = document.getElementById('pdf-password');
        
        const enableOcr = document.getElementById('enable-ocr');
        const ocrWarning = document.getElementById('ocr-warning');
        
        let imageFiles = new Map();
        let ignoreSequenceWarning = false;
        let sequenceStatus = 'none'; // 'none', 'partial', 'full'

        // --- Notifications ---
        function showNotification(message, type = 'info', duration = 4000) {
            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                warning: 'bg-amber-500',
                error: 'bg-red-500',
            };
            const icons = {
                info: 'info',
                success: 'check-circle',
                warning: 'alert-triangle',
                error: 'x-circle'
            };
            
            const notification = document.createElement('div');
            notification.className = `p-4 text-white rounded-lg shadow-lg transform transition-all duration-300 ease-out opacity-0 translate-x-10 notification ${colors[type]}`;
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <i data-lucide="${icons[type]}" class="w-5 h-5 mr-3 mt-0.5 flex-shrink-0"></i>
                    <div>${message}</div>
                </div>
            `;
            
            notificationContainer.appendChild(notification);
            lucide.createIcons();

            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-x-10');
                notification.classList.add('opacity-100', 'translate-x-0');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('opacity-100', 'translate-x-0');
                notification.classList.add('opacity-0', 'translate-x-10');
                notification.addEventListener('transitionend', () => notification.remove());
            }, duration);
        }

        // --- Modal Control ---
        closeModalBtn.addEventListener('click', () => {
            sequenceErrorModal.classList.add('hidden');
            imageFiles.clear();
            renderAllPreviews();
        });

        ignoreSequenceBtn.addEventListener('click', () => {
            sequenceErrorModal.classList.add('hidden');
            ignoreSequenceWarning = true;
            showNotification('已忽略顺序警告，请手动调整图片顺序', 'warning');
        });

        manualSortBtn.addEventListener('click', () => {
            sequenceErrorModal.classList.add('hidden');
            showNotification('请手动拖拽图片调整顺序', 'info');
            // Highlight the sortable area
            sortableList.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => {
                sortableList.classList.remove('ring-2', 'ring-blue-500');
            }, 3000);
        });

        // --- Settings Panel ---
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            const header = card.querySelector('.card-header');
            const body = card.querySelector('.card-body');
            const icon = header.querySelector('i');
            
            header.addEventListener('click', () => {
                body.classList.toggle('collapsed');
                icon.classList.toggle('rotate-180');
            });
        });
        
        enablePassword.addEventListener('change', () => {
            passwordContainer.classList.toggle('hidden', !enablePassword.checked);
        });

        enableOcr.addEventListener('change', () => {
            ocrWarning.classList.toggle('hidden', !enableOcr.checked);
            if(enableOcr.checked) {
                showNotification('实验性OCR功能将显著增加处理时间，并可能导致浏览器无响应。', 'warning');
            }
        });

        clearAllBtn.addEventListener('click', () => {
            if (imageFiles.size === 0) return;
            
            // Revoke all object URLs to prevent memory leaks
            imageFiles.forEach(fileData => {
                URL.revokeObjectURL(fileData.objectUrl);
            });
            
            imageFiles.clear();
            renderAllPreviews();
            showNotification('已清空所有图片', 'info');
        });

        sortSequenceBtn.addEventListener('click', () => {
            if (imageFiles.size === 0) return;
            
            // Sort files by natural order if they contain numbers
            const sortedEntries = [...imageFiles.entries()].sort((a, b) => naturalSort(a[1].file.name, b[1].file.name));
            imageFiles = new Map(sortedEntries);
            
            renderAllPreviews();
            showNotification('已按文件名顺序排序', 'success');
        });

        // --- Drag and Drop ---
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            e.target.value = ''; // Reset for re-uploading the same file
        });

        // --- SortableJS ---
        let sortable = new Sortable(sortableList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onUpdate: function() {
                showNotification('已调整图片顺序', 'info', 2000);
            }
        });

        // --- File Sequence Validation ---
        function validateFileSequence(files) {
            if (files.length === 0) return true;
            if (ignoreSequenceWarning) return true;
            
            const numberRegex = new RegExp('\\d+');
            let hasNumbers = 0;
            let allHaveNumbers = true;
            
            for (const file of files) {
                if (numberRegex.test(file.name)) {
                    hasNumbers++;
                } else {
                    allHaveNumbers = false;
                }
            }
            
            // Determine sequence status
            if (hasNumbers === 0) {
                sequenceStatus = 'none';
                return false;
            } else if (hasNumbers === files.length) {
                sequenceStatus = 'full';
                return true;
            } else {
                sequenceStatus = 'partial';
                return false;
            }
        }

        // --- File Handling and Preview ---
        function handleFiles(files) {
            const totalFiles = files.length;
            const newImageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

            const ignoredCount = totalFiles - newImageFiles.length;
            if (ignoredCount > 0) {
                showNotification(`已忽略 ${ignoredCount} 个非图片文件`, 'warning');
            }
            if (newImageFiles.length === 0) return;

            if (!validateFileSequence(newImageFiles)) {
                sequenceErrorModal.classList.remove('hidden');
                lucide.createIcons();
                return;
            }
            
            // Update step progress
            document.getElementById('step-2').classList.add('completed');
            document.getElementById('step-3').classList.add('active');
            
            newImageFiles.forEach(file => {
                const id = `${Date.now()}-${Math.random()}`;
                const objectUrl = URL.createObjectURL(file);
                imageFiles.set(id, { file, objectUrl });
            });
            
            // Sort files by natural order if they contain numbers
            if (sequenceStatus === 'full') {
                const sortedEntries = [...imageFiles.entries()].sort((a, b) => naturalSort(a[1].file.name, b[1].file.name));
                imageFiles = new Map(sortedEntries);
            }
            
            renderAllPreviews();
            showNotification(`已添加 ${newImageFiles.length} 张图片`, 'success');
        }
        
        function renderAllPreviews() {
            sortableList.innerHTML = '';
            imageFiles.forEach((fileData, id) => {
                const previewItem = createPreviewElement({ id, ...fileData });
                sortableList.appendChild(previewItem);
            });
            lucide.createIcons();
            updateUploadZoneVisibility();
            
            // Update image count
            imageCount.textContent = imageFiles.size;
            
            // Show/hide buttons
            clearAllBtn.classList.toggle('hidden', imageFiles.size === 0);
            sortSequenceBtn.classList.toggle('hidden', imageFiles.size === 0 || sequenceStatus !== 'full');
        }
        
        function createPreviewElement({ id, file, objectUrl }) {
            const item = document.createElement('div');
            item.className = 'image-preview-item aspect-square bg-slate-100 fade-in';
            item.dataset.id = id;

            // Add sequence indicator
            const sequenceIndicator = document.createElement('div');
            sequenceIndicator.className = 'sequence-indicator';
            
            if (sequenceStatus === 'full') {
                // Extract number from filename
                const match = file.name.match(/\d+/);
                if (match) {
                    sequenceIndicator.textContent = match[0];
                    sequenceIndicator.classList.add('sequence-indicator');
                }
            } else if (sequenceStatus === 'partial') {
                sequenceIndicator.textContent = '!';
                sequenceIndicator.classList.add('sequence-warning');
            } else {
                sequenceIndicator.textContent = '✗';
                sequenceIndicator.classList.add('sequence-error');
            }

            item.innerHTML = `
                <img src="${objectUrl}" alt="${file.name}" class="w-full h-full object-cover" loading="lazy">
                <div class="image-overlay">
                    <button class="delete-btn text-white p-2 rounded-full bg-red-500/90 hover:bg-red-600 transition-colors" data-id="${id}">
                        <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                    </button>
                </div>
                <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-2 truncate">
                    ${file.name}
                </div>
            `;
            
            item.appendChild(sequenceIndicator);
            
            item.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const fileId = e.currentTarget.dataset.id;
                const fileData = imageFiles.get(fileId);
                
                if (fileData) {
                    URL.revokeObjectURL(fileData.objectUrl);
                    imageFiles.delete(fileId);
                }
                
                item.remove();
                updateUploadZoneVisibility();
                imageCount.textContent = imageFiles.size;
                clearAllBtn.classList.toggle('hidden', imageFiles.size === 0);
                sortSequenceBtn.classList.toggle('hidden', imageFiles.size === 0 || sequenceStatus !== 'full');
                
                showNotification('已删除图片', 'info', 2000);
            });

            return item;
        }

        function updateUploadZoneVisibility() {
            const hasFiles = imageFiles.size > 0;
            uploadZone.classList.toggle('hidden', hasFiles);
            generatePdfBtn.disabled = !hasFiles;
        }

        // --- Natural Sorting Logic ---
        function naturalSort(a, b) {
            const re = new RegExp('(\\d+)', 'g');
            const ax = a.split(re);
            const bx = b.split(re);

            for (let i = 0; i < Math.min(ax.length, bx.length); i++) {
                const partA = ax[i];
                const partB = bx[i];
                const numA = parseInt(partA, 10);
                const numB = parseInt(partB, 10);

                if (!isNaN(numA) && !isNaN(numB)) {
                    if (numA !== numB) return numA - numB;
                } else {
                    const comparison = partA.localeCompare(partB);
                    if (comparison !== 0) return comparison;
                }
            }
            return ax.length - bx.length;
        }

        // --- PDF Generation ---
        generatePdfBtn.addEventListener('click', generatePdf);

        async function generatePdf() {
            if (imageFiles.size === 0) {
                showNotification('请先上传图片！', 'warning');
                return;
            }

            setLoading(true, '准备生成PDF...');

            try {
                const pdfDoc = await PDFDocument.create();
                
                const sortedIds = Array.from(sortableList.children).map(item => item.dataset.id);
                const orderedFiles = sortedIds.map(id => imageFiles.get(id).file);

                const options = getPdfOptions();

                if (enablePassword.checked && pdfPassword.value) {
                    pdfDoc.setProducer('ImageToPDF Tool');
                    pdfDoc.setCreator('Neo');
                    pdfDoc.encrypt({
                        userPassword: pdfPassword.value,
                        ownerPassword: pdfPassword.value,
                        permissions: { printing: 'highResolution', modifying: false, copying: true, annotating: true },
                    });
                }
                
                const { Tesseract } = window;
                let ocrWorker = null;
                if(options.ocrEnabled){
                    setLoading(true, '正在初始化OCR引擎...');
                    ocrWorker = await Tesseract.createWorker('eng', 1, {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = (m.progress * 100).toFixed(0);
                                setLoading(true, `OCR识别中: ${progress}%`);
                            }
                        }
                    });
                }
                
                for (let i = 0; i < orderedFiles.length; i++) {
                    const file = orderedFiles[i];
                    setLoading(true, `正在处理图片 ${i + 1}/${orderedFiles.length}...`);
                    
                    const fileBuffer = await file.arrayBuffer();
                    let image;
                    try {
                        if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
                            image = await pdfDoc.embedJpg(fileBuffer);
                        } else {
                            image = await pdfDoc.embedPng(fileBuffer);
                        }
                    } catch (error) {
                        console.error('Error embedding image:', error);
                        showNotification(`处理图片 ${file.name} 时出错，已跳过`, 'error');
                        continue;
                    }

                    const pageDimensions = getPageDimensions(options.pageSize, options.orientation);
                    const page = pdfDoc.addPage([pageDimensions.width, pageDimensions.height]);

                    const drawableWidth = page.getWidth() - options.marginLeft - options.marginRight;
                    const drawableHeight = page.getHeight() - options.marginTop - options.marginBottom;
                    
                    const scaled = image.scaleToFit(drawableWidth, drawableHeight);

                    page.drawImage(image, {
                        x: options.marginLeft + (drawableWidth - scaled.width) / 2,
                        y: options.marginBottom + (drawableHeight - scaled.height) / 2,
                        width: scaled.width,
                        height: scaled.height,
                        opacity: 1,
                    });
                    
                    if (options.ocrEnabled && ocrWorker) {
                        setLoading(true, `OCR识别中 (${i + 1}/${orderedFiles.length})...`);
                        try {
                            const { data } = await ocrWorker.recognize(file);
                            if(data.text) {
                               const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
                               page.drawText(data.text, {
                                   x: 5, y: 5, size: 5, font, color: rgb(0, 0, 0), opacity: 0,
                               });
                            }
                        } catch (ocrError) {
                            console.error('OCR Error:', ocrError);
                            showNotification('OCR处理失败，继续生成PDF', 'warning');
                        }
                    }
                }

                if(ocrWorker) await ocrWorker.terminate();

                setLoading(true, '正在生成PDF文件...');
                const pdfBytes = await pdfDoc.save({ imageQuality: options.quality });
                
                downloadPdf(pdfBytes);
                
                showNotification('PDF 生成成功!', 'success');
                setLoading(false, '完成!');
                setTimeout(() => { progressText.textContent = ''; }, 3000);

            } catch (error) {
                console.error('PDF generation failed:', error);
                showNotification('PDF生成失败: ' + error.message, 'error');
                setLoading(false, '生成失败');
            } finally {
                setLoading(false);
            }
        }
        
        function getPdfOptions() {
            const qualityValue = document.querySelector('input[name="quality"]:checked').value;
            const orientation = document.querySelector('input[name="orientation"]:checked').value;
            const pageSize = document.getElementById('page-size').value;
            const mmToPoints = (mm) => mm * 2.83465;

            return {
                quality: parseFloat(qualityValue),
                orientation: orientation,
                pageSize: pageSize,
                marginTop: mmToPoints(parseFloat(document.getElementById('margin-top').value) || 0),
                marginBottom: mmToPoints(parseFloat(document.getElementById('margin-bottom').value) || 0),
                marginLeft: mmToPoints(parseFloat(document.getElementById('margin-left').value) || 0),
                marginRight: mmToPoints(parseFloat(document.getElementById('margin-right').value) || 0),
                ocrEnabled: enableOcr.checked,
            };
        }
        
        function getPageDimensions(size, orientation) {
            let dimensions;
            switch(size) {
                case 'A3': dimensions = PageSizes.A3; break;
                case 'A5': dimensions = PageSizes.A5; break;
                case 'Letter': dimensions = PageSizes.Letter; break;
                case 'Legal': dimensions = PageSizes.Legal; break;
                default: dimensions = PageSizes.A4;
            }
            
            if (orientation === 'landscape') {
                return { width: dimensions[1], height: dimensions[0] };
            }
            return { width: dimensions[0], height: dimensions[1] };
        }

        function downloadPdf(bytes) {
            const blob = new Blob([bytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `converted_${Date.now()}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function setLoading(isLoading, message = '') {
            if (message) {
                progressText.textContent = message;
            }
            
            generatePdfBtn.disabled = isLoading;
            if (isLoading) {
                btnText.classList.add('hidden');
                btnLoader.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        }
    });
    </script>
</body>
</html>